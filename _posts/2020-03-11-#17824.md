---
layout: pr
date: 2020-03-11
title: "Improve coin selection for destination groups >10"
pr: 17824
authors: [fjahr]
components: ["wallet"]
host: fjahr
status: upcoming
commit:
---

## Notes

Today's PR is a partial fix to a bug report filed last November, [#17603
"partial spend avoidance makes partial spends and getbalances doesn't
notice."](https://github.com/bitcoin/bitcoin/issues/17603) In that issue,
Bitcoin Core contributor [dooglus](https://github.com/dooglus) describes two
ways the wallet does not behave as expected when using the `avoid_reuse` wallet
flag (sidenote: this issue is an excellent example of a good bug report, with
detailed steps to reproduce the issue).

This PR addresses one of the two bugs with a fairly small fix, but there is much
to dig into regarding `avoid_reuse`, coin selection, and whether this is the
best solution to the problem.

The `avoid_reuse` wallet flag was introduced in
[#13756](https://github.com/bitcoin/bitcoin/pull/13756) by
[kallewoof](https://github.com/kallewoof), who subsequently followed it up with
[#16239](https://github.com/bitcoin/bitcoin/pull/16239) to mitigate exposure to
[dust
attacks](https://bitcoin.stackexchange.com/questions/81508/deanonymizing-dust-attack/81509#81509). The
`avoid_reuse` feature achieves this by:
  1. avoiding spending from destinations that the wallet has previously spent from,
and
  2. attempting to sweep larger parts of the outputs to a destination when it
does spend, from a destination that has multiple outputs available.

Today's PR addresses the latter of the two. The main keyword to look for in the
code is `GroupOutputs`.

The other error reported in issue
[#17603](https://github.com/bitcoin/bitcoin/issues/17603) was a
misrepresentation of the wallet balances in the RPC `getbalances`. This was
resolved by [#17843 "wallet: Reset reused transactions
cache"](https://github.com/bitcoin/bitcoin/pull/17843).

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or
NACK?](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)
(Don't forget to put your PR review on GitHub.)

2. This PR deals with the broad topic of Coin Selection (here is a recommended
[reference
work](http://murch.one/wp-content/uploads/2016/11/erhardt2016coinselection.pdf)
on the subject by [Murch](https://github.com/Xekyo)). Coin selection changes seem
to have a hard time getting reviews. Why do you think that is? What are some bad
things that can happen if something goes wrong in coin selection?

3. What is the problem with coin reuse? How can it be exploited, and what
approach does the `avoid_reuse` feature employ to solve it? Are you aware of
other ways to mitigate attacks, perhaps implemented by other privacy-focused
wallets?

4. Can you describe the problem this PR tries to solve in your own words, including
the necessary pre-conditions?

5. How does this PR currently attempt to resolve the issue?

6. How does the current approach compare to [the previously proposed
approach](https://github.com/bitcoin/bitcoin/pull/17824#issuecomment-569928051)
by the author? Can you think of other (better?) ways to solve it?

7. More generally, do you like the way `avoid_reuse` currently handles this case
of coin selection? Can you think of different solutions to the problem?


<!-- TODO: uncomment and add meeting log
## Meeting Log
```
```
--->
